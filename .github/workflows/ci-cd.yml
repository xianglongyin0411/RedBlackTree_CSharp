# name: CI Pipeline

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:
#   unit-tests:
#     name: Run Unit Tests
#     runs-on: self-hosted
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Restore dependencies
#         run: dotnet restore UnitTest/UnitTest.csproj
#         shell: cmd

#       - name: Run unit tests
#         run: dotnet test UnitTest/UnitTest.csproj --logger "trx;LogFileName=test-results.trx"
#         shell: cmd

#       - name: Upload test results
#         if: success() || failure()
#         uses: actions/upload-artifact@v3
#         with:
#           name: test-results
#           path: UnitTest/TestResults/*.trx

#   test-report:
#     name: Generate Test Report
#     needs: unit-tests
#     runs-on: self-hosted
#     steps:
#       - name: Download test results
#         uses: actions/download-artifact@v3
#         with:
#           name: test-results

#       - name: Generate test report
#         uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
#         with:
#           artifact: test-results
#           name: Unit Test Report
#           path: UnitTest/TestResults/*.trx
#           reporter: dotnet-trx

name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restore dependencies
        run: dotnet restore UnitTest/UnitTest.csproj
        shell: cmd

      - name: Run unit tests
        run: |
          dotnet test UnitTest/UnitTest.csproj --logger "trx;LogFileName=test-results.trx" --results-directory ./_TestResults 
        shell: cmd

      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: ./_TestResults/*.trx  # 直接上传根目录下的文件

  test-report:
    name: Generate Test Report
    needs: unit-tests
    runs-on: self-hosted
    steps:
      - name: Download test results
        uses: actions/download-artifact@v3
        with:
          name: test-results

      - name: Generate test report
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5
        with:
          artifact: test-results  # 自动匹配下载的文件夹
          name: Unit Test Report
          # 直接指向下载后的文件（无需原始目录）
          path: test-results/*.trx 
          reporter: dotnet-trx